---
import Default from "@astrojs/starlight/components/PageTitle.astro";
import { Icon } from "@astrojs/starlight/components";

const config = {
  prompt: "Please analyze this documentation: {url}",
  baseUrl: Astro.site?.href || "https://your-site.com"
};

const currentPath = Astro.url.pathname.replace(/\/$/, "");
const currentUrl = Astro.url.href.replace(/\/$/, ".md");

const prompt = config.prompt?.includes("{url}")
  ? config.prompt?.replace("{url}", currentUrl)
  : `${config.prompt} ${currentUrl}`;
const encodedPrompt = encodeURIComponent(prompt as string);

const options = [
  {
    label: "Open in ChatGPT",
    href: `https://chatgpt.com/?q=${encodedPrompt}`,
  },
  {
    label: "Open in Claude",
    href: `https://claude.ai/new?q=${encodedPrompt}`,
  },
];
---

<h1>{Astro.locals.starlightRoute.entry.data.title}</h1>
{Astro.locals.starlightRoute.entry.data.description && (
  <p class="page-description">{Astro.locals.starlightRoute.entry.data.description}</p>
)}
<div class="actions-container">
  <button class="action-button" id="copy-markdown" data-path={currentPath}>
    <Icon name="mdx" size="1rem" class="icon-default" />
    <Icon name="approve-check" size="1rem" class="icon-success" />
    <span>Copy Markdown</span>
  </button>

  <button class="action-button" id="export-pdf">
    <Icon name="document" size="1rem" />
    <span>Export PDF</span>
  </button>

  <div class="dropdown">
    <button
      class="action-button"
      id="dropdown-toggle"
      aria-label="More options"
    >
      <span>Open</span>
      <Icon name="down-caret" size="1rem" />
    </button>

    <div id="dropdown-menu">
      {
        options.map((option) => {
          return (
            <a href={option.href} class="dropdown-item" target="_blank">
              <span>{option.label}</span>
              <Icon name="external" size="1rem" class="external-icon" />
            </a>
          );
        })
      }
    </div>
  </div>
</div>

<script>
  function initButtons() {
    // 复制 Markdown 按钮
    const copyBtn = document.getElementById('copy-markdown') as HTMLButtonElement;
    if (copyBtn && !copyBtn.dataset.initialized) {
      copyBtn.dataset.initialized = 'true';
      
      copyBtn.addEventListener('click', async () => {
        if (copyBtn.disabled) return;
        
        const path = copyBtn.dataset.path;
        if (!path) return;
        
        try {
          copyBtn.disabled = true;
          const response = await fetch(path + '.md');
          const markdown = await response.text();
          await navigator.clipboard.writeText(markdown);
          
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.classList.remove('copied');
          }, 3000);
        } catch (err) {
          console.error('Copy failed:', err);
        } finally {
          copyBtn.disabled = false;
        }
      });
    }

    // PDF 导出按钮
    const pdfBtn = document.getElementById('export-pdf') as HTMLButtonElement;
    if (pdfBtn && !pdfBtn.dataset.initialized) {
      pdfBtn.dataset.initialized = 'true';
      
      pdfBtn.addEventListener('click', async () => {
        const hasKatex = document.querySelector('.katex') !== null;
        
        if (hasKatex) {
          console.log('检测到 KaTeX 公式，等待渲染完成...');
          
          if (document.readyState !== 'complete') {
            await new Promise(resolve => {
              window.addEventListener('load', () => resolve(null));
            });
          }
          
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        window.print();
      });
    }

    // 下拉菜单
    const toggle = document.getElementById('dropdown-toggle') as HTMLButtonElement;
    const menu = document.getElementById('dropdown-menu') as HTMLDivElement;
    
    if (toggle && menu && !toggle.dataset.initialized) {
      toggle.dataset.initialized = 'true';
      
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('show');
      });
      
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      if (!document.body.dataset.dropdownListenerAdded) {
        document.body.dataset.dropdownListenerAdded = 'true';
        document.addEventListener('click', () => {
          const currentMenu = document.getElementById('dropdown-menu');
          if (currentMenu) {
            currentMenu.classList.remove('show');
          }
        });
      }
    }
  }

  document.addEventListener('DOMContentLoaded', initButtons);
  document.addEventListener('astro:page-load', initButtons);
</script>

<style>
  h1 {
    margin-top: 1.8rem;
    font-size: var(--sl-text-h1);
    line-height: var(--sl-line-height-headings);
    font-weight: 600;
    color: var(--sl-color-white);
  }
  .page-description {
    margin-top: 1.3rem;
    font-size: 1.1rem;
    font-weight: 400;
    color: var(--sl-color-gray-2);
    line-height: 1.6;
  }
    
  .actions-container {
    display: flex;
    gap: 0.5rem;
  }

  .action-button {
    background-color: var(--sl-color-gray-6);
    color: var(--sl-color-white);
    border: 1px solid var(--sl-color-gray-5);
    padding: 0.5rem 0.75rem;
    border-radius: 0.35rem;
    font-size: 0.75rem;
    font-weight: 400;
    cursor: pointer;
    font-family: var(--sl-font);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: opacity 0.2s ease;
    height: 1.9rem;
    line-height: 1;
  }

  #copy-markdown:disabled {
    opacity: 0.7;
  }

  .icon-success {
    display: none;
  }

  #copy-markdown.copied .icon-default {
    display: none;
  }

  #copy-markdown.copied .icon-success {
    display: block;
  }

  .dropdown {
    position: relative;
  }

  #dropdown-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background-color: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.25rem;
    padding: 0.25rem;
    min-width: 200px;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 2px 4px -1px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 10;
  }

  #dropdown-menu.show {
    display: block;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    color: var(--sl-color-white);
    text-decoration: none;
    border-radius: 0.25rem;
    font-size: 0.7rem;
    transition: background-color 0.15s ease;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background-color: var(--sl-color-gray-5);
  }

  .dropdown-item span {
    flex: 1;
  }

  .dropdown-item .external-icon {
    margin-left: auto;
  }

  @media print {
    .actions-container,
    nav,
    aside,
    header {
      display: none !important;
    }
    
    body {
      background: white;
    }
  }
</style>
