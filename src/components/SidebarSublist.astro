---
import type { StarlightRouteData } from '@astrojs/starlight/route-data'

interface Props {
  sublist: StarlightRouteData['sidebar']
  nested?: boolean
}

const { sublist, nested = false } = Astro.props
---

<nav class:list={{ 'sidebar-group': true, nested }}>
  {
    sublist.map((entry) =>
      entry.type === 'link' ? (
        <a
          href={entry.href}
          aria-current={entry.isCurrent && 'page'}
          class:list={['entry-link', entry.attrs.class]}
          {...entry.attrs}
        >
          <span class="entry-label">{entry.label}</span>
          {entry.badge && <span class="entry-badge">{entry.badge.text}</span>}
        </a>
      ) : (
        <details class="container-sidebar-entry" open={!nested}>
          <summary class="entry-title">{entry.label}</summary>
          <div class="container-group-link">
            <Astro.self sublist={entry.entries} nested={true} />
          </div>
        </details>
      )
    )
  }
</nav>

<!-- ✅ 用前端脚本控制导航行为 -->
<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.entry-link')
    const details = document.querySelectorAll('.container-sidebar-entry')

    // 记住展开状态
    details.forEach((d) => {
      const key = d.querySelector('summary')?.textContent?.trim()
      const saved = localStorage.getItem('sidebar:' + key)
      if (saved === 'open') d.setAttribute('open', '')
      d.addEventListener('toggle', () => {
        localStorage.setItem('sidebar:' + key, d.open ? 'open' : 'closed')
      })
    })

    // 重新初始化 Starlight 的交互功能
    function reinitializeStarlight() {
      // 重新初始化目录高亮
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.getAttribute('id')
            if (entry.isIntersecting) {
              document.querySelectorAll('.right-sidebar a').forEach((link) => {
                link.classList.remove('active')
                if (link.getAttribute('href') === `#${id}`) {
                  link.classList.add('active')
                }
              })
            }
          })
        },
        { rootMargin: '-100px 0px -66%' }
      )

      // 观察所有标题
      document.querySelectorAll('main h2, main h3, main h4').forEach((heading) => {
        observer.observe(heading)
      })

      // 重新绑定目录点击事件
      document.querySelectorAll('.right-sidebar a').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault()
          const id = link.getAttribute('href')?.slice(1)
          const target = document.getElementById(id)
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' })
            history.pushState(null, '', `#${id}`)
          }
        })
      })

      // 触发 Astro 的页面加载事件
      document.dispatchEvent(new Event('astro:page-load'))
    }

    // 防止点击当前页刷新
    links.forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget
        if (target.getAttribute('aria-current') === 'page') {
          e.preventDefault()
          return
        }
        // 平滑加载内容 (仿 SPA)
        e.preventDefault()
        const url = target.getAttribute('href')
        if (!url) return
        
        // 移除所有旧的 aria-current
        document.querySelectorAll('.entry-link[aria-current="page"]').forEach(el => {
          el.removeAttribute('aria-current')
        })
        
        // 设置新的 aria-current
        target.setAttribute('aria-current', 'page')
        
        fetch(url)
          .then((r) => r.text())
          .then((html) => {
            const doc = new DOMParser().parseFromString(html, 'text/html')
            const newContent = doc.querySelector('main')
            const newRightSidebar = doc.querySelector('.right-sidebar')
            const current = document.querySelector('main')
            const currentRightSidebar = document.querySelector('.right-sidebar')
            
            if (newContent && current) {
              current.replaceWith(newContent)
              
              // 同时替换右侧边栏（目录）
              if (newRightSidebar && currentRightSidebar) {
                currentRightSidebar.replaceWith(newRightSidebar)
              }
              
              history.pushState({}, '', url)
              window.scrollTo(0, 0)
              
              // 重新初始化 Starlight 功能
              reinitializeStarlight()
              
              // 更新页面标题
              const newTitle = doc.querySelector('title')?.textContent
              if (newTitle) {
                document.title = newTitle
              }
            }
          })
          .catch(err => {
            console.error('Navigation failed:', err)
            // 降级：直接跳转
            window.location.href = url
          })
      })
    })

    // 初始化时也执行一次
    reinitializeStarlight()
  })
</script>

<style>
  /* ===== Sidebar总体布局 ===== */
  .sidebar-group {
    display: flex;
    flex-direction: column;
  }

  /* ===== 折叠容器 ===== */
  .container-sidebar-entry {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  /* ===== 折叠标题 ===== */
  .entry-title {
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.4rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    list-style: none;
    user-select: none;
  }

  /* 隐藏默认的小箭头 */
  .entry-title::-webkit-details-marker {
    display: none;
  }

  .entry-title::marker {
    display: none;
  }

  summary.entry-title {
    list-style-type: none;
  }

  .entry-title:hover {
    background-color: var(--sl-color-gray-6);
  }

  /* ===== 链接项 ===== */
  .entry-link {
    display: flex;
    align-items: center;
    padding: 0.4rem 0.75rem;
    border-radius: 0.6rem;
    text-decoration: none;
    color: inherit;
    font-size: 0.83rem;
    font-weight: 400;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  /* hover 灰底 */
  .entry-link:hover {
    background-color: var(--sl-color-gray-6);
  }

  /* 当前页高亮：金色柔光底 */
  .entry-link[aria-current='page'] {
    background-color: #fff7e6;
    color: #b88400;
    font-weight: 400;
  }

  .entry-link[aria-current='page']:hover {
    background-color: #ffefcc;
  }

  /* ===== 子层级 ===== */
  .container-group-link {
    display: grid;
    gap: 0.25rem;
    padding-left: 1rem;

  }

  /* ===== Badge 标签 ===== */
  .entry-badge {
    font-size: 0.7rem;
    font-weight: 600;
    color: #222;
    padding: 0.15rem 0.4rem;
    border-radius: 0.375rem;
    background-color: rgb(255 230 128 / 90%);
    margin-left: 0.5rem;
  }
</style>
