---
import type { StarlightRouteData } from '@astrojs/starlight/route-data'
import { initButtons } from './action.js'

interface Props {
  sublist: StarlightRouteData['sidebar']
  nested?: boolean
}

const { sublist, nested = false } = Astro.props
---

<nav class:list={{ 'sidebar-group': true, nested }}>
  {
    sublist.map((entry) =>
      entry.type === 'link' ? (
        <a
          href={entry.href}
          aria-current={entry.isCurrent && 'page'}
          class:list={['entry-link', entry.attrs.class]}
          {...entry.attrs}
        >
          <span class="entry-label">{entry.label}</span>
          {entry.badge && <span class="entry-badge">{entry.badge.text}</span>}
        </a>
      ) : (
        <details class="container-sidebar-entry" open={!nested}>
          <summary class="entry-title">{entry.label}</summary>
          <div class="container-group-link">
            <Astro.self sublist={entry.entries} nested={true} />
          </div>
        </details>
      )
    )
  }
</nav>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.entry-link')
    const details = document.querySelectorAll('.container-sidebar-entry')

    // è®°ä½å±•å¼€çŠ¶æ€
    details.forEach((d) => {
      const key = d.querySelector('summary')?.textContent?.trim()
      const saved = localStorage.getItem('sidebar:' + key)
      if (saved === 'open') d.setAttribute('open', '')
      d.addEventListener('toggle', () => {
        localStorage.setItem('sidebar:' + key, d.open ? 'open' : 'closed')
      })
    })

    // ğŸ”¥ åˆå§‹åŒ–æŒ‰é’®åŠŸèƒ½
    function initButtons() {
      // å¤åˆ¶æŒ‰é’®
      const copyBtn = document.getElementById('copy-markdown')
      if (copyBtn && !copyBtn.dataset.initialized) {
        copyBtn.dataset.initialized = 'true'
        
        copyBtn.addEventListener('click', async () => {
          if (copyBtn.disabled) return
          
          const path = copyBtn.dataset.path
          if (!path) return
          
          try {
            copyBtn.disabled = true
            const response = await fetch(path + '.md')
            const markdown = await response.text()
            await navigator.clipboard.writeText(markdown)
            
            copyBtn.classList.add('copied')
            setTimeout(() => {
              copyBtn.classList.remove('copied')
            }, 3000)
          } catch (err) {
            console.error('Copy failed:', err)
          } finally {
            copyBtn.disabled = false
          }
        })
      }

      // ğŸ”¥ PDF å¯¼å‡ºæŒ‰é’®
      const pdfBtn = document.getElementById('export-pdf')
      if (pdfBtn && !pdfBtn.dataset.initialized) {
        pdfBtn.dataset.initialized = 'true'
        
        pdfBtn.addEventListener('click', async () => {
          // æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰ KaTeX å…¬å¼
          const hasKatex = document.querySelector('.katex') !== null
          
          if (hasKatex) {
            console.log('æ£€æµ‹åˆ° KaTeX å…¬å¼ï¼Œç­‰å¾…æ¸²æŸ“å®Œæˆ...')
            
            // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
            if (document.readyState !== 'complete') {
              await new Promise(resolve => {
                window.addEventListener('load', () => resolve(null))
              })
            }
            
            // é¢å¤–ç­‰å¾… 500ms ç¡®ä¿ KaTeX æ¸²æŸ“å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 500))
          }
          
          // è§¦å‘æ‰“å°
          window.print()
        })
      }

      // ä¸‹æ‹‰èœå•
      const toggle = document.getElementById('dropdown-toggle')
      const menu = document.getElementById('dropdown-menu')
      
      if (toggle && menu && !toggle.dataset.initialized) {
        toggle.dataset.initialized = 'true'
        
        toggle.addEventListener('click', (e) => {
          e.stopPropagation()
          menu.classList.toggle('show')
        })
        
        // ç‚¹å‡»èœå•å†…éƒ¨ä¸å…³é—­
        menu.addEventListener('click', (e) => {
          e.stopPropagation()
        })
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
        if (!document.body.dataset.dropdownListenerAdded) {
          document.body.dataset.dropdownListenerAdded = 'true'
          document.addEventListener('click', () => {
            const currentMenu = document.getElementById('dropdown-menu')
            if (currentMenu) {
              currentMenu.classList.remove('show')
            }
          })
        }
      }
    }

    // é‡æ–°åˆå§‹åŒ– Starlight çš„äº¤äº’åŠŸèƒ½
    function reinitializeStarlight() {
      // é‡æ–°åˆå§‹åŒ–ç›®å½•é«˜äº®
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.getAttribute('id')
            if (entry.isIntersecting) {
              document.querySelectorAll('.right-sidebar a').forEach((link) => {
                link.classList.remove('active')
                if (link.getAttribute('href') === `#${id}`) {
                  link.classList.add('active')
                }
              })
            }
          })
        },
        { rootMargin: '-100px 0px -66%' }
      )

      // è§‚å¯Ÿæ‰€æœ‰æ ‡é¢˜
      document.querySelectorAll('main h2, main h3, main h4').forEach((heading) => {
        observer.observe(heading)
      })

      // é‡æ–°ç»‘å®šç›®å½•ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.right-sidebar a').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault()
          const id = link.getAttribute('href')?.slice(1)
          const target = document.getElementById(id)
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' })
            history.pushState(null, '', `#${id}`)
          }
        })
      })

      // ğŸ”¥ é‡æ–°åˆå§‹åŒ–æŒ‰é’®
      initButtons()

      // è§¦å‘ Astro çš„é¡µé¢åŠ è½½äº‹ä»¶
      document.dispatchEvent(new Event('astro:page-load'))
    }

    // é˜²æ­¢ç‚¹å‡»å½“å‰é¡µåˆ·æ–°
    links.forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget
        if (target.getAttribute('aria-current') === 'page') {
          e.preventDefault()
          return
        }
        
        // å¹³æ»‘åŠ è½½å†…å®¹ (ä»¿ SPA)
        e.preventDefault()
        const url = target.getAttribute('href')
        if (!url) return
        
        // ç§»é™¤æ‰€æœ‰æ—§çš„ aria-current
        document.querySelectorAll('.entry-link[aria-current="page"]').forEach(el => {
          el.removeAttribute('aria-current')
        })
        
        // è®¾ç½®æ–°çš„ aria-current
        target.setAttribute('aria-current', 'page')
        
        fetch(url)
          .then((r) => r.text())
          .then((html) => {
            const doc = new DOMParser().parseFromString(html, 'text/html')
            const newContent = doc.querySelector('main')
            const newRightSidebar = doc.querySelector('.right-sidebar')
            const current = document.querySelector('main')
            const currentRightSidebar = document.querySelector('.right-sidebar')
            
            if (newContent && current) {
              current.replaceWith(newContent)
              
              // åŒæ—¶æ›¿æ¢å³ä¾§è¾¹æ ï¼ˆç›®å½•ï¼‰
              if (newRightSidebar && currentRightSidebar) {
                currentRightSidebar.replaceWith(newRightSidebar)
              }
              
              history.pushState({}, '', url)
              window.scrollTo(0, 0)
              
              // é‡æ–°åˆå§‹åŒ– Starlight åŠŸèƒ½
              reinitializeStarlight()
              
              // æ›´æ–°é¡µé¢æ ‡é¢˜
              const newTitle = doc.querySelector('title')?.textContent
              if (newTitle) {
                document.title = newTitle
              }
            }
          })
          .catch(err => {
            console.error('Navigation failed:', err)
            // é™çº§ï¼šç›´æ¥è·³è½¬
            window.location.href = url
          })
      })
    })

    // åˆå§‹åŒ–æ—¶ä¹Ÿæ‰§è¡Œä¸€æ¬¡
    reinitializeStarlight()
  })
</script>

<style>
  /* ===== Sidebaræ€»ä½“å¸ƒå±€ ===== */
  .sidebar-group {
    display: flex;
    flex-direction: column;
  }

  /* ===== æŠ˜å å®¹å™¨ ===== */
  .container-sidebar-entry {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  /* ===== æŠ˜å æ ‡é¢˜ ===== */
  .entry-title {
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.4rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    list-style: none;
    user-select: none;
  }

  /* éšè—é»˜è®¤çš„å°ç®­å¤´ */
  .entry-title::-webkit-details-marker {
    display: none;
  }

  .entry-title::marker {
    display: none;
  }

  summary.entry-title {
    list-style-type: none;
  }

  .entry-title:hover {
    background-color: var(--sl-color-gray-6);
  }

  /* ===== é“¾æ¥é¡¹ ===== */
  .entry-link {
    display: flex;
    align-items: center;
    padding: 0.4rem 0.75rem;
    border-radius: 0.6rem;
    text-decoration: none;
    color: inherit;
    font-size: 0.83rem;
    font-weight: 400;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  /* hover ç°åº• */
  .entry-link:hover {
    background-color: var(--sl-color-gray-6);
  }

  /* å½“å‰é¡µé«˜äº®ï¼šé‡‘è‰²æŸ”å…‰åº• */
  .entry-link[aria-current='page'] {
    background-color: #fff7e6;
    color: #b88400;
    font-weight: 400;
  }

  .entry-link[aria-current='page']:hover {
    background-color: #ffefcc;
  }

  /* ===== å­å±‚çº§ ===== */
  .container-group-link {
    display: grid;
    gap: 0.25rem;
    padding-left: 1rem;

  }

  /* ===== Badge æ ‡ç­¾ ===== */
  .entry-badge {
    font-size: 0.7rem;
    font-weight: 600;
    color: #222;
    padding: 0.15rem 0.4rem;
    border-radius: 0.375rem;
    background-color: rgb(255 230 128 / 90%);
    margin-left: 0.5rem;
  }
</style>
