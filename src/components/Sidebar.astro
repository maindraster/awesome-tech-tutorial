---
import Search from 'virtual:starlight/components/Search';
import SiteTitle from 'virtual:starlight/components/SiteTitle';
import MobileMenuFooter from 'virtual:starlight/components/MobileMenuFooter';
import TopicsDropdown from './TopicsDropdown.astro';
import SidebarSublist from './SidebarSublist.astro';
import config from 'virtual:starlight/user-config';

const { sidebar } = Astro.locals.starlightRoute;

const shouldRenderSearch =
  config.pagefind ||
  config.components.Search !== '@astrojs/starlight/components/Search.astro';
---

<div class="sidebar-container">
  <div class="sidebar-top-fixed">
    <div class="title-wrapper">
      <div class="title-with-toggle">
        <span class="site-title">∀∅ 万工笔记</span>
        <button 
          id="sidebar-collapse-btn" 
          class="sidebar-toggle-btn"
        >
          <i class="iconfont icon-left"></i>
        </button>
      </div>
    </div>
    {shouldRenderSearch && <Search />}
    <div class="topics-wrapper">
      <TopicsDropdown />
    </div>
  </div>
  <div class="sidebar-scroll-area">
    <div class="sidebar-section sidebar-main">
      <div class="container-sidebar">
        <SidebarSublist sublist={sidebar} />
      </div>
    </div>
  </div>

  <div class="mobile-footer-floating">
    <MobileMenuFooter />
  </div>
</div>

<script>
  // 侧边栏折叠逻辑
  const STORAGE_KEY = 'starlight-sidebar-collapsed';
  
  function initSidebarCollapse() {
    const collapseBtn = document.getElementById('sidebar-collapse-btn');
    const sidebarPane = document.getElementById('starlight__sidebar');
    const mainFrame = document.querySelector('.main-frame');
    
    if (!collapseBtn || !sidebarPane) return;

    // 读取保存的状态
    const isCollapsed = localStorage.getItem(STORAGE_KEY) === 'true';
    
    // 初始化状态
    if (isCollapsed) {
      sidebarPane.classList.add('collapsed');
      mainFrame?.classList.add('sidebar-collapsed');
      // 触发自定义事件通知展开按钮
      window.dispatchEvent(new CustomEvent('sidebar-state-changed', { detail: { collapsed: true } }));
    }

    // 折叠按钮点击
    collapseBtn.addEventListener('click', () => {
      sidebarPane.classList.add('collapsed');
      mainFrame?.classList.add('sidebar-collapsed');
      localStorage.setItem(STORAGE_KEY, 'true');
      // 触发自定义事件
      window.dispatchEvent(new CustomEvent('sidebar-state-changed', { detail: { collapsed: true } }));
    });
  }

  // 监听展开事件
  window.addEventListener('sidebar-expand', () => {
    const sidebarPane = document.getElementById('starlight__sidebar');
    const mainFrame = document.querySelector('.main-frame');
    
    if (sidebarPane) {
      sidebarPane.classList.remove('collapsed');
      mainFrame?.classList.remove('sidebar-collapsed');
      localStorage.setItem(STORAGE_KEY, 'false');
    }
  });

  // 页面加载时初始化
  initSidebarCollapse();
  
  // 处理页面导航（Astro 的 View Transitions）
  document.addEventListener('astro:page-load', () => {
    initSidebarCollapse();
  });
</script>

<style>
  /* ===============================
   整体布局
  =============================== */
  .sidebar-container {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: var(--sl-color-bg-sidebar, var(--sl-color-bg));
    overflow: hidden;
    overscroll-behavior: contain;
  }

  /* ===============================
   顶部固定区（标题 + 搜索 + TopicsDropdown）
  =============================== */
  .sidebar-top-fixed {
    position: sticky;
    top: 0;
    left: 0;
    z-index: 20;
    background: var(--sl-color-bg-sidebar, var(--sl-color-bg));
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 0.5rem 1rem 1rem;
  }

  .sidebar-top-fixed::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(
      to top,
      transparent,
      var(--sl-color-bg-sidebar, var(--sl-color-bg))
    );
    pointer-events: none;
  }

  /* ===============================
   标题和折叠按钮
  =============================== */
  .title-wrapper {
    margin-bottom: 0.75rem;
  }

  .title-with-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .site-title {
    font-weight: 600;
    font-size: 1.125rem;
    color: var(--sl-color-text-accent);
  }

  .sidebar-toggle-btn {
    display: none; /* 默认隐藏，只在桌面端显示 */
    padding: 0.225rem; /* 0.375 * 0.6 = 0.225 */
    background: transparent;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    cursor: pointer;
    color: var(--sl-color-gray-2);
    transition: all 0.2s ease;
    flex-shrink: 0;
    width: 1.8rem;  /* 约为原来的 0.6 倍 */
    height: 1.8rem; /* 约为原来的 0.6 倍 */
  }

  .sidebar-toggle-btn .iconfont {
    font-size: 0.75rem; /* 12px，图标大小调整为 0.6 倍 */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sidebar-toggle-btn:hover {
    background: var(--sl-color-gray-6);
    border-color: var(--sl-color-gray-4);
    color: var(--sl-color-white);
  }

  .sidebar-toggle-btn:active {
    transform: scale(0.95);
  }

  /* ===============================
   中间滚动区域
  =============================== */
  .sidebar-scroll-area {
    flex: 1;
    overflow-y: auto;
    margin-top: -1.25rem;
    padding: 1rem;
    padding-bottom: 0rem;
    box-sizing: border-box;
    overscroll-behavior: contain;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .sidebar-scroll-area::-webkit-scrollbar {
    display: none;
  }

  .container-sidebar {
    gap: 1.5rem;
    flex-direction: column;
    display: flex;
  }

  .sidebar-top-fixed > :global(.pagefind-ui) {
    margin-bottom: 1.25rem;
  }

  .topics-wrapper {
    margin-top: 0.75rem;
  }

  /* ===============================
   底部固定 Footer
  =============================== */
  .mobile-footer-floating {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 30;
    height: 3rem;
    background: var(--sl-color-bg-sidebar, var(--sl-color-bg));
    border-top: 1px solid var(--sl-color-hairline-shade);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  /* ===============================
   桌面端显示折叠按钮
  =============================== */
  @media (min-width: 50rem) {
    .sidebar-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }

  /* ===============================
   移动端优化
  =============================== */
  @media (max-width: 49.99rem) {
    .sidebar-scroll-area {
      padding-bottom: 6rem;
    }

    .sidebar-top-fixed {
      background: var(--sl-color-black);
      padding: 0.25rem 1rem 1rem;
    }

    .sidebar-top-fixed::after {
      background: linear-gradient(to top, transparent, var(--sl-color-black));
    }

    .mobile-footer-floating {
      background: var(--sl-color-black);
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }
  }

  @media (min-width: 1024px) {
    .sidebar-scroll-area {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }
</style>
